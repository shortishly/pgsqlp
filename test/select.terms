%% -*- mode: erlang -*-
%% Copyright (c) 2023 Peter Morgan <peter.james.morgan@gmail.com>
%%
%% Licensed under the Apache License, Version 2.0 (the "License");
%% you may not use this file except in compliance with the License.
%% You may obtain a copy of the License at
%%
%% http://www.apache.org/licenses/LICENSE-2.0
%%
%% Unless required by applicable law or agreed to in writing, software
%% distributed under the License is distributed on an "AS IS" BASIS,
%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
%% See the License for the specific language governing permissions and
%% limitations under the License.


{{<<>>,
  [{action,select},
   {distinct,true},
   {output,
    [{group_subexpression,
      {case_expression,
       [{clauses,
         [[{condition,
            {group_subexpression,
             {operator_invocation,
              {infix_operator,
               [{function_call,
                 [{function_name,<<"array_length">>},
                  {function_args,
                   [{column_reference,{<<"gpt">>,<<"attrs">>}},
                    {numeric_literal,1}]}]},
                {operator,<<"=">>},
                {column_reference,{<<"c">>,<<"relnatts">>}}]}}}},
           {then,{null_literal,<<"NULL">>}}]]},
        {otherwise,{column_reference,{<<"gpt">>,<<"attrs">>}}}]}}]},
   {from,
    [{from_item,
      [{table_name,[<<"pg_publication">>]},{table_alias,<<"p">>}]},
     {from_item,
      [{lateral,true},
       {function_call,
        [{function_name,<<"pg_get_publication_tables">>},
         {function_args,
          [{column_reference,{<<"p">>,<<"pubname">>}}]}]},
       {table_alias,<<"gpt">>}]},
     {from_item,
      [{table_name,[<<"pg_class">>]},{table_alias,<<"c">>}]}]},
   {where,
    {operator_invocation,
     {infix_operator,
      [{column_reference,{<<"gpt">>,<<"relid">>}},
       {operator,<<"=">>},
       {numeric_literal,16613},
       {operator,<<"AND">>},
       {column_reference,{<<"c">>,<<"oid">>}},
       {operator,<<"=">>},
       {column_reference,{<<"gpt">>,<<"relid">>}},
       {operator,<<"AND">>},
       {in,[{column_references,
             [{column_reference,{<<"p">>,<<"pubname">>}}]},
            [{string_literal,<<"pub">>}]]}]}}}]},
 <<"SELECT DISTINCT  (CASE WHEN (array_length(gpt.attrs, 1) = c.relnatts)   THEN NULL ELSE gpt.attrs END)  FROM pg_publication p,  LATERAL pg_get_publication_tables(p.pubname) gpt,  pg_class c WHERE gpt.relid = 16613 AND c.oid = gpt.relid   AND p.pubname IN ( 'pub' )">>}.

{{<<>>,
  [{action,select},
   {output,[{function_call,[{function_name,{<<"pg_catalog">>,
                                            <<"set_config">>}},
                            {function_args,[{string_literal,<<"search_path">>},
                                            {string_literal,<<>>},
                                            {boolean_literal,false}]}]}]}]},
 <<"SELECT pg_catalog.set_config('search_path', '', false)">>}.


{{<<>>,
  [{action,select},
   {output,[{column_reference,{<<"t">>,<<"pubname">>}}]},
   {from,[{from_item,[{table_name,[<<"pg_catalog">>,
                                   <<"pg_publication">>]},
                      {table_alias,<<"t">>}]}]},
   {where,{in,[{column_references,[{column_reference,{<<"t">>,
                                                      <<"pubname">>}}]},
               [{string_literal,<<"pub">>}]]}}]},
 <<"SELECT t.pubname FROM\n pg_catalog.pg_publication t WHERE\n t.pubname IN ('pub')">>}.

{{<<>>,
  [{action,select},
   {distinct,true},
   {output,[{column_reference,{<<"t">>,<<"schemaname">>}},
            {column_reference,{<<"t">>,<<"tablename">>}}]},
   {from,[{from_item,[{table_name,[<<"pg_catalog">>,
                                   <<"pg_publication_tables">>]},
                      {table_alias,<<"t">>}]}]},
   {where,{in,[{column_references,[{column_reference,{<<"t">>,
                                                      <<"pubname">>}}]},
               [{string_literal,<<"pub">>}]]}}]},
 <<"SELECT DISTINCT t.schemaname, t.tablename \nFROM pg_catalog.pg_publication_tables t\n WHERE t.pubname IN ('pub')">>}.

{{<<>>,
  [{action,select},
   {distinct,true},
   {output,[{column_reference,{<<"t">>,<<"schemaname">>}},
            {column_reference,{<<"t">>,<<"tablename">>}},
            {column_reference,{<<"t">>,<<"attnames">>}}]},
   {from,[{from_item,[{table_name,[<<"pg_catalog">>,
                                   <<"pg_publication_tables">>]},
                      {table_alias,<<"t">>}]}]},
   {where,{in,[{column_references,[{column_reference,{<<"t">>,
                                                      <<"pubname">>}}]},
               [{string_literal,<<"pub">>}]]}}]},
 <<"SELECT DISTINCT t.schemaname, t.tablename \n, t.attnames\nFROM pg_catalog.pg_publication_tables t\n WHERE t.pubname IN ('pub')">>}.

{{<<>>,
  [{action,select},
   {output,[{column_reference,{<<"c">>,<<"oid">>}},
            {column_reference,{<<"c">>,<<"relreplident">>}},
            {column_reference,{<<"c">>,<<"relkind">>}}]},
   {from,[{from_item,[{table_name,[<<"pg_catalog">>,
                                   <<"pg_class">>]},
                      {table_alias,<<"c">>},
                      {join_type,<<"INNER JOIN">>},
                      {from_item,[{table_name,[<<"pg_catalog">>,
                                               <<"pg_namespace">>]},
                                  {table_alias,<<"n">>}]},
                      {operator_invocation,{infix_operator,[{column_reference,{<<"c">>,
                                                                               <<"relnamespace">>}},
                                                            {operator,<<"=">>},
                                                            {column_reference,{<<"n">>,<<"oid">>}}]}}]}]},
   {where,{operator_invocation,{infix_operator,[{column_reference,{<<"n">>,
                                                                   <<"nspname">>}},
                                                {operator,<<"=">>},
                                                {string_literal,<<"public">>},
                                                {operator,<<"AND">>},
                                                {column_reference,{<<"c">>,<<"relname">>}},
                                                {operator,<<"=">>},
                                                {string_literal,<<"col_json">>}]}}}]},
 <<"SELECT c.oid, c.relreplident, c.relkind  FROM pg_catalog.pg_class c  INNER JOIN pg_catalog.pg_namespace n        ON (c.relnamespace = n.oid) WHERE n.nspname = 'public'   AND c.relname = 'col_json'">>}.

{{<<>>,
  [{action,select},
   {output,[{column_reference,{<<"a">>,<<"attnum">>}},
            {column_reference,{<<"a">>,<<"attname">>}},
            {column_reference,{<<"a">>,<<"atttypid">>}},
            {operator_invocation,{infix_operator,[{column_reference,{<<"a">>,
                                                                     <<"attnum">>}},
                                                  {operator,<<"=">>},
                                                  {function_call,[{function_name,<<"ANY">>},
                                                                  {function_args,[{column_reference,{<<"i">>,
                                                                                                     <<"indkey">>}}]}]}]}}]},
   {from,[{from_item,[{table_name,[<<"pg_catalog">>,
                                   <<"pg_attribute">>]},
                      {table_alias,<<"a">>},
                      {join_type,<<"LEFT JOIN">>},
                      {from_item,[{table_name,[<<"pg_catalog">>,<<"pg_index">>]},
                                  {table_alias,<<"i">>}]},
                      {operator_invocation,{infix_operator,[{column_reference,{<<"i">>,
                                                                               <<"indexrelid">>}},
                                                            {operator,<<"=">>},
                                                            {function_call,[{function_name,<<"pg_get_replica_identity_index">>},
                                                                            {function_args,[{numeric_literal,16613}]}]}]}}]}]},
   {where,{operator_invocation,{infix_operator,[{column_reference,{<<"a">>,
                                                                   <<"attnum">>}},
                                                {operator,<<">">>},
                                                {type_cast,[{numeric_literal,0},
                                                            {type_name,[<<"pg_catalog">>,<<"int2">>]}]},
                                                {operator,<<"AND NOT">>},
                                                {column_reference,{<<"a">>,<<"attisdropped">>}},
                                                {operator,<<"AND">>},
                                                {column_reference,{<<"a">>,<<"attrelid">>}},
                                                {operator,<<"=">>},
                                                {numeric_literal,16613}]}}},
   {order_by,{column_reference,{<<"a">>,<<"attnum">>}}}]},
 <<"SELECT a.attnum,       a.attname,       a.atttypid,       a.attnum = ANY(i.indkey)  FROM pg_catalog.pg_attribute a  LEFT JOIN pg_catalog.pg_index i       ON (i.indexrelid = pg_get_replica_identity_index(16613)) WHERE a.attnum > 0::pg_catalog.int2   AND NOT a.attisdropped    AND a.attrelid = 16613 ORDER BY a.attnum">>}.


{{<<>>,
 [{action,select},
  {output,
   [{column_reference,{<<"a">>,<<"attnum">>}},
    {column_reference,{<<"a">>,<<"attname">>}},
    {column_reference,{<<"a">>,<<"atttypid">>}},
    {operator_invocation,
     {infix_operator,
      [{column_reference,{<<"a">>, <<"attnum">>}},
       {operator,<<"=">>},
       {function_call,
        [{function_name,<<"ANY">>},
         {function_args,
          [{column_reference,{<<"i">>, <<"indkey">>}}]}]}]}}]},
  {from,
   [{from_item,
     [{table_name,[<<"pg_catalog">>, <<"pg_attribute">>]},
      {table_alias,<<"a">>},
      {join_type,<<"LEFT JOIN">>},
      {from_item,
       [{table_name,[<<"pg_catalog">>,<<"pg_index">>]},
        {table_alias,<<"i">>}]},
      {operator_invocation,
       {infix_operator,
        [{column_reference,{<<"i">>, <<"indexrelid">>}},
         {operator,<<"=">>},
         {function_call,
          [{function_name,<<"pg_get_replica_identity_index">>},
           {function_args,[{numeric_literal,16613}]}]}]}}]}]},
  {where,
   {operator_invocation,
    {infix_operator,
     [{column_reference,{<<"a">>, <<"attnum">>}},
      {operator,<<">">>},
      {type_cast,[{numeric_literal,0},
                  {type_name,[<<"pg_catalog">>,<<"int2">>]}]},
      {operator,<<"AND NOT">>},
      {column_reference,{<<"a">>,<<"attisdropped">>}},
      {operator,<<"AND">>},
      {column_reference,{<<"a">>,<<"attgenerated">>}},
      {operator,<<"=">>},
      {string_literal,<<>>},
      {operator,<<"AND">>},
      {column_reference,{<<"a">>,<<"attrelid">>}},
      {operator,<<"=">>},
      {numeric_literal,16613}]}}},
  {order_by,{column_reference,{<<"a">>,<<"attnum">>}}}]},
 <<"SELECT a.attnum,       a.attname,       a.atttypid,       a.attnum = ANY(i.indkey)  FROM pg_catalog.pg_attribute a  LEFT JOIN pg_catalog.pg_index i       ON (i.indexrelid = pg_get_replica_identity_index(16613)) WHERE a.attnum > 0::pg_catalog.int2   AND NOT a.attisdropped AND a.attgenerated = ''   AND a.attrelid = 16613 ORDER BY a.attnum">>}.


{{<<>>,
 [{action,select},
  {distinct,true},
  {output,
   [{function_call,
     [{function_name,<<"pg_get_expr">>},
      {function_args,
       [{column_reference,{<<"gpt">>,<<"qual">>}},
        {column_reference,{<<"gpt">>,<<"relid">>}}]}]}]},
  {from,
   [{from_item,
     [{table_name,[<<"pg_publication">>]},
      {table_alias,<<"p">>}]},
    {from_item,
     [{lateral,true},
      {function_call,
       [{function_name,<<"pg_get_publication_tables">>},
        {function_args,[{column_reference,{<<"p">>, <<"pubname">>}}]}]},
      {table_alias,<<"gpt">>}]}]},
  {where,
   {operator_invocation,
    {infix_operator,
     [{column_reference,{<<"gpt">>, <<"relid">>}},
      {operator,<<"=">>},
      {numeric_literal,16613},
      {operator,<<"AND">>},
      {in,[{column_references,[{column_reference,{<<"p">>, <<"pubname">>}}]},
           [{string_literal,<<"pub">>}]]}]}}}]},
<<"SELECT DISTINCT pg_get_expr(gpt.qual, gpt.relid)  FROM pg_publication p,  LATERAL pg_get_publication_tables(p.pubname) gpt WHERE gpt.relid = 16613   AND p.pubname IN ( 'pub' )">>}.
